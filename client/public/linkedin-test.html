<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LinkedIn OAuth Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      padding: 20px;
      line-height: 1.5;
      color: #333;
      max-width: 800px;
      margin: 0 auto;
    }
    h1 {
      color: #0077B5;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
    }
    .container {
      margin-top: 30px;
    }
    .test-section {
      background: #f7f9fa;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .test-button {
      display: inline-block;
      background-color: #0077B5;
      color: white;
      text-decoration: none;
      padding: 10px 20px;
      border-radius: 4px;
      margin: 10px 0;
      font-weight: bold;
    }
    .test-button:hover {
      background-color: #005e93;
    }
    .error-box {
      background-color: #fff0f0;
      border-left: 4px solid #d00;
      padding: 15px;
      margin: 20px 0;
    }
    .info-box {
      background-color: #f0f7ff;
      border-left: 4px solid #0077B5;
      padding: 15px;
      margin: 20px 0;
    }
    .solution-box {
      background-color: #f0fff0;
      border-left: 4px solid #0a0;
      padding: 15px;
      margin: 20px 0;
    }
    code {
      background: #f0f0f0;
      padding: 2px 4px;
      border-radius: 3px;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <h1>LinkedIn OAuth Test Page</h1>
  
  <div class="error-box">
    <h3>Current Errors</h3>
    <ul>
      <li><strong>Access Denied:</strong> "This application is not allowed to create application tokens"</li>
      <li><strong>Connection Refused:</strong> www.linkedin.com refused to connect</li>
    </ul>
  </div>
  
  <div class="info-box">
    <h3>About This Error</h3>
    <p>These errors indicate that your LinkedIn Developer application needs configuration adjustments:</p>
    <ul>
      <li>Your application may not be properly set up in the LinkedIn Developer Console</li>
      <li>The redirect URI in your LinkedIn Developer Console may not match what your app is using</li>
      <li>You may need to set the correct OAuth 2.0 scopes in your LinkedIn Developer Console</li>
      <li>Your application might not be approved for the scopes it's requesting</li>
    </ul>
    
    <div id="credentials-box" style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 4px;">
      <h4>Current Credentials Check</h4>
      <div id="credentials-info">Loading credential info...</div>
      <button id="check-credentials-btn" style="margin-top: 10px;">Check Credentials</button>
    </div>
  </div>
  
  <div class="solution-box">
    <h3>How to Fix It</h3>
    <ol>
      <li>
        <strong>Check your LinkedIn Developer Console Settings:</strong>
        <ul>
          <li>Go to <a href="https://www.linkedin.com/developers/apps" target="_blank">LinkedIn Developer Portal</a></li>
          <li>Open your application</li>
          <li>Go to the "Auth" tab</li>
        </ul>
      </li>
      <li>
        <strong>Verify OAuth 2.0 Settings:</strong>
        <ul>
          <li>Add these redirect URIs (exact match required):</li>
          <li><code id="callback-uri-1"></code></li>
          <li><code id="callback-uri-2"></code></li>
          <li><code id="callback-uri-3"></code></li>
        </ul>
      </li>
      <li>
        <strong>Check Application Permissions:</strong>
        <ul>
          <li>Ensure your app has these OAuth 2.0 scopes:</li>
          <li><code>r_liteprofile</code></li>
          <li><code>r_emailaddress</code></li>
        </ul>
      </li>
      <li>
        <strong>Application Use Case:</strong>
        <ul>
          <li>If your app is in "Development" mode, you can only use it with developer accounts</li>
          <li>You may need to request access for the scopes you're using</li>
          <li>Check if your application's use case has been approved by LinkedIn</li>
        </ul>
      </li>
    </ol>
  </div>

  <div class="container">
    <div class="test-section">
      <h2>Test LinkedIn Connection</h2>
      <p>Try different auth options to see which one works:</p>
      
      <div>
        <h3>1. Simple Root Callback</h3>
        <a href="#" id="simple-auth-link" class="test-button">Test Simple Auth</a>
        <p><strong>Redirect URI:</strong> <code id="simple-uri"></code></p>
      </div>
      
      <div>
        <h3>2. API Path Callback</h3>
        <a href="#" id="api-auth-link" class="test-button">Test API Auth</a>
        <p><strong>Redirect URI:</strong> <code id="api-uri"></code></p>
      </div>
      
      <div>
        <h3>3. Default App Callback</h3>
        <a href="#" id="default-auth-link" class="test-button">Test Default Auth</a>
        <p><strong>Redirect URI:</strong> <code id="default-uri"></code></p>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const baseUrl = window.location.origin;
      
      // Check if this is a Replit environment
      const isReplit = window.location.hostname.includes('replit.dev') || 
                       window.location.hostname.includes('repl.co');
      
      // Get the appropriate domain for redirect URIs
      let domainForRedirect;
      
      if (isReplit) {
        // Get Replit domain
        const hostname = window.location.hostname;
        
        if (hostname.includes('replit.dev')) {
          // Development environment - use hostname directly
          domainForRedirect = `https://${hostname}`;
        } else if (hostname.includes('repl.co')) {
          // Production environment - use hostname directly since it's already correct
          domainForRedirect = `https://${hostname}`;
        } else {
          // Fallback to baseUrl
          domainForRedirect = baseUrl;
        }
      } else {
        // Not Replit - use baseUrl
        domainForRedirect = baseUrl;
      }
      
      // Add info about detected environment
      const infoBox = document.querySelector('.info-box');
      if (isReplit) {
        infoBox.innerHTML += `
          <div style="margin-top: 15px; padding: 10px; background: #e6f7ff; border-radius: 4px;">
            <h4>Environment Information</h4>
            <p><strong>Replit Environment Detected</strong></p>
            <p>Using domain: <code>${domainForRedirect}</code></p>
            <p>Make sure this exact domain is authorized in your LinkedIn Developer Console.</p>
          </div>
        `;
      }
      
      // Set callback URIs for the instructions
      document.getElementById('callback-uri-1').textContent = `${domainForRedirect}/callback`;
      document.getElementById('callback-uri-2').textContent = `${domainForRedirect}/api/callback`;
      document.getElementById('callback-uri-3').textContent = `${domainForRedirect}/api/auth/linkedin/callback`;
      
      // Set up the test links
      const simpleUri = `${domainForRedirect}/callback`;
      const apiUri = `${domainForRedirect}/api/callback`;
      const defaultUri = `${domainForRedirect}/api/auth/linkedin/callback`;
      
      document.getElementById('simple-uri').textContent = simpleUri;
      document.getElementById('api-uri').textContent = apiUri;
      document.getElementById('default-uri').textContent = defaultUri;
      
      // Check credentials on load
      try {
        const credResponse = await fetch('/api/linkedin/check-credentials');
        const credData = await credResponse.json();
        
        let credHtml = '';
        if (credData.clientIdExists && credData.clientSecretExists) {
          credHtml = `
            <div style="color: green; font-weight: bold;">✓ Credentials are configured</div>
            <p>Client ID starts with: <code>${credData.clientIdPrefix}</code></p>
            <p>Client Secret starts with: <code>${credData.clientSecretPrefix}</code></p>
            <p>Updated: ${new Date(credData.timestamp).toLocaleTimeString()}</p>
          `;
        } else {
          credHtml = `
            <div style="color: red; font-weight: bold;">⚠ Credentials are missing</div>
            <p>Client ID: ${credData.clientIdExists ? '✓ Set' : '✗ Missing'}</p>
            <p>Client Secret: ${credData.clientSecretExists ? '✓ Set' : '✗ Missing'}</p>
          `;
        }
        
        document.getElementById('credentials-info').innerHTML = credHtml;
      } catch (error) {
        document.getElementById('credentials-info').innerHTML = `<div style="color: red;">Error checking credentials: ${error.message}</div>`;
      }
      
      // Add credential check button handler
      document.getElementById('check-credentials-btn').addEventListener('click', async () => {
        document.getElementById('credentials-info').innerHTML = 'Checking credentials...';
        try {
          const credResponse = await fetch('/api/linkedin/check-credentials');
          const credData = await credResponse.json();
          
          let credHtml = '';
          if (credData.clientIdExists && credData.clientSecretExists) {
            credHtml = `
              <div style="color: green; font-weight: bold;">✓ Credentials are configured</div>
              <p>Client ID starts with: <code>${credData.clientIdPrefix}</code></p>
              <p>Client Secret starts with: <code>${credData.clientSecretPrefix}</code></p>
              <p>Updated: ${new Date(credData.timestamp).toLocaleTimeString()}</p>
            `;
          } else {
            credHtml = `
              <div style="color: red; font-weight: bold;">⚠ Credentials are missing</div>
              <p>Client ID: ${credData.clientIdExists ? '✓ Set' : '✗ Missing'}</p>
              <p>Client Secret: ${credData.clientSecretExists ? '✓ Set' : '✗ Missing'}</p>
            `;
          }
          
          document.getElementById('credentials-info').innerHTML = credHtml;
        } catch (error) {
          document.getElementById('credentials-info').innerHTML = `<div style="color: red;">Error checking credentials: ${error.message}</div>`;
        }
      });
      
      // Set up link handlers
      document.getElementById('simple-auth-link').addEventListener('click', async (e) => {
        e.preventDefault();
        try {
          const response = await fetch(`/api/auth/linkedin/generate?callbackPath=/callback`);
          const data = await response.json();
          window.location.href = data.url;
        } catch (error) {
          alert('Error generating auth URL: ' + error.message);
        }
      });
      
      document.getElementById('api-auth-link').addEventListener('click', async (e) => {
        e.preventDefault();
        try {
          const response = await fetch(`/api/auth/linkedin/generate?callbackPath=/api/callback`);
          const data = await response.json();
          window.location.href = data.url;
        } catch (error) {
          alert('Error generating auth URL: ' + error.message);
        }
      });
      
      document.getElementById('default-auth-link').addEventListener('click', async (e) => {
        e.preventDefault();
        try {
          const response = await fetch(`/api/auth/linkedin/generate?callbackPath=/api/auth/linkedin/callback`);
          const data = await response.json();
          window.location.href = data.url;
        } catch (error) {
          alert('Error generating auth URL: ' + error.message);
        }
      });
    });
  </script>
</body>
</html>