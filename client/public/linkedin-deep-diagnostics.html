<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LinkedIn OAuth Deep Diagnostics</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      padding: 20px;
      line-height: 1.5;
      color: #333;
      max-width: 1100px;
      margin: 0 auto;
    }
    h1, h2, h3 {
      color: #0077B5;
    }
    .card {
      background: #f7f9fa;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .status-box {
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
    }
    .error {
      background-color: #fff0f0;
      border-left: 4px solid #d00;
    }
    .success {
      background-color: #f0fff0;
      border-left: 4px solid #0a0;
    }
    .info {
      background-color: #f0f7ff;
      border-left: 4px solid #0077B5;
    }
    .warning {
      background-color: #fffcf0;
      border-left: 4px solid #f0ad4e;
    }
    pre, code {
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 14px;
    }
    code {
      padding: 2px 5px;
      display: inline-block;
    }
    pre code {
      padding: 0;
    }
    button, .button {
      display: inline-block;
      background-color: #0077B5;
      color: white;
      text-decoration: none;
      padding: 10px 20px;
      border-radius: 4px;
      margin: 10px 5px 10px 0;
      font-weight: bold;
      border: none;
      cursor: pointer;
    }
    button:hover, .button:hover {
      background-color: #005e93;
    }
    button.secondary {
      background-color: #6c757d;
    }
    button.secondary:hover {
      background-color: #5a6268;
    }
    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 15px 0;
    }
    input[type="text"], select {
      width: 100%;
      padding: 10px;
      margin: 5px 0 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .checkbox-group {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .checkbox-group input[type="checkbox"] {
      margin-right: 10px;
    }
    details {
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
    }
    summary {
      font-weight: bold;
      cursor: pointer;
      padding: 5px;
    }
    .copy-button {
      background-color: #eee;
      color: #333;
      border: 1px solid #ddd;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
      margin-left: 6px;
      cursor: pointer;
    }
    .copy-button:hover {
      background-color: #ddd;
    }
    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border: 1px solid transparent;
      border-bottom: none;
      margin-right: 5px;
      border-radius: 4px 4px 0 0;
    }
    .tab.active {
      background-color: #f7f9fa;
      border-color: #ddd;
      position: relative;
    }
    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 1px;
      background-color: #f7f9fa;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    tr:nth-child(even) {
      background-color: #f7f9fa;
    }
    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      margin-right: 5px;
    }
    .badge-success {
      background-color: #d4edda;
      color: #155724;
    }
    .badge-warning {
      background-color: #fff3cd;
      color: #856404;
    }
    .badge-danger {
      background-color: #f8d7da;
      color: #721c24;
    }
    #test-results {
      margin-top: 20px;
    }
    .log-entry {
      border-left: 3px solid #ddd;
      padding-left: 10px;
      margin-bottom: 10px;
    }
    .log-time {
      color: #666;
      font-size: 0.8em;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      grid-gap: 20px;
    }
    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
    .log-container {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 15px;
      padding: 10px;
      background-color: #f5f5f5;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>LinkedIn OAuth Deep Diagnostics</h1>
  
  <div class="status-box info">
    <h3>üîç Diagnostic Tool</h3>
    <p>This tool helps identify and resolve LinkedIn OAuth integration issues by systematically testing each component of the authentication flow.</p>
    <p><strong>Current Issue:</strong> <span id="current-issue">LinkedIn refuses to connect</span></p>
  </div>
  
  <div class="tabs">
    <div class="tab active" data-tab="credentials">1. Credentials</div>
    <div class="tab" data-tab="redirect">2. Redirect URIs</div>
    <div class="tab" data-tab="permissions">3. Permissions</div>
    <div class="tab" data-tab="test-flow">4. Test Flow</div>
    <div class="tab" data-tab="logs">5. Logs</div>
  </div>
  
  <div id="credentials" class="tab-content active">
    <div class="card">
      <h2>LinkedIn Credentials Verification</h2>
      <div id="credentials-status"></div>
      <button id="check-credentials" class="button">Check Current Credentials</button>
      
      <div style="margin-top: 20px;">
        <h3>Expected Credentials</h3>
        <table>
          <tr>
            <th>Credential</th>
            <th>Expected Value</th>
            <th>Current Status</th>
          </tr>
          <tr>
            <td>Client ID</td>
            <td><code>86t5psw5yh4oj0</code></td>
            <td id="client-id-status"><span class="badge badge-warning">Checking...</span></td>
          </tr>
          <tr>
            <td>Client Secret</td>
            <td><code>WPL_AP1.JgMbqw5nJ6BTOojJ.5ErhgA==</code></td>
            <td id="client-secret-status"><span class="badge badge-warning">Checking...</span></td>
          </tr>
        </table>
      </div>
    </div>
  </div>
  
  <div id="redirect" class="tab-content">
    <div class="card">
      <h2>Redirect URI Verification</h2>
      <p>LinkedIn requires that the redirect URI used in the authentication request exactly matches one of the authorized redirect URIs in your LinkedIn application settings.</p>
      
      <div id="redirect-uri-status" class="status-box info">
        <h3>Available Redirect URIs</h3>
        <p>The following redirect URIs are generated based on your application's environment. Make sure at least one of these is configured in your LinkedIn application settings.</p>
      </div>
      
      <div class="grid">
        <div>
          <h3>Application Environment</h3>
          <table id="environment-table">
            <tr>
              <th>Variable</th>
              <th>Value</th>
            </tr>
            <tr>
              <td>REPL_SLUG</td>
              <td id="repl-slug">Checking...</td>
            </tr>
            <tr>
              <td>REPL_OWNER</td>
              <td id="repl-owner">Checking...</td>
            </tr>
            <tr>
              <td>Base URL</td>
              <td id="base-url">Checking...</td>
            </tr>
          </table>
        </div>
        
        <div>
          <h3>Potential Redirect URIs</h3>
          <div id="redirect-uris-list"></div>
        </div>
      </div>
      
      <div style="margin-top: 20px;">
        <h3>Test Specific Redirect URI</h3>
        <select id="redirect-uri-select">
          <option value="">Select a redirect URI to test...</option>
        </select>
        <button id="test-redirect-uri" class="button">Test Selected URI</button>
      </div>
    </div>
  </div>
  
  <div id="permissions" class="tab-content">
    <div class="card">
      <h2>LinkedIn Application Permissions</h2>
      <p>Your LinkedIn application must have the right permissions and products enabled.</p>
      
      <div class="status-box info">
        <h3>Required Products & Permissions</h3>
        <ul>
          <li><strong>Products:</strong> Sign In with LinkedIn</li>
          <li><strong>OAuth 2.0 Scopes:</strong> r_liteprofile, r_emailaddress</li>
          <li><strong>Application Status:</strong> Must be in ACTIVE state</li>
        </ul>
      </div>
      
      <h3>Scope Testing</h3>
      <div class="checkbox-group">
        <input type="checkbox" id="scope-profile" checked>
        <label for="scope-profile">r_liteprofile</label>
      </div>
      <div class="checkbox-group">
        <input type="checkbox" id="scope-email" checked>
        <label for="scope-email">r_emailaddress</label>
      </div>
      
      <button id="test-scopes" class="button">Test Selected Scopes</button>
    </div>
  </div>
  
  <div id="test-flow" class="tab-content">
    <div class="card">
      <h2>Complete Authentication Flow Test</h2>
      <p>Test the complete LinkedIn OAuth flow with the selected parameters.</p>
      
      <div class="grid">
        <div>
          <h3>Authentication Parameters</h3>
          
          <label for="client-id-input">Client ID:</label>
          <input type="text" id="client-id-input" placeholder="e.g., 86t5psw5yh4oj0">
          
          <label for="redirect-uri-input">Redirect URI:</label>
          <select id="redirect-uri-input"></select>
          
          <label for="scope-input">Scopes:</label>
          <input type="text" id="scope-input" value="r_liteprofile r_emailaddress">
          
          <button id="run-full-test" class="button">Run Full Authentication Test</button>
        </div>
        
        <div>
          <h3>Test Results</h3>
          <div id="test-results">No tests run yet</div>
        </div>
      </div>
    </div>
  </div>
  
  <div id="logs" class="tab-content">
    <div class="card">
      <h2>Diagnostic Logs</h2>
      <p>Review detailed logs of all authentication attempts and diagnostic tests.</p>
      
      <div class="button-group">
        <button id="clear-logs" class="button secondary">Clear Logs</button>
        <button id="export-logs" class="button secondary">Export Logs</button>
      </div>
      
      <div class="log-container">
        <div id="log-entries"></div>
      </div>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // Tab navigation
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          // Remove active class from all tabs and content
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          // Add active class to clicked tab and corresponding content
          tab.classList.add('active');
          const tabName = tab.getAttribute('data-tab');
          document.getElementById(tabName).classList.add('active');
        });
      });
      
      // Logging system
      const logEntries = document.getElementById('log-entries');
      function addLog(message, type = 'info') {
        const logTime = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.className = `log-entry log-${type}`;
        logEntry.innerHTML = `
          <span class="log-time">[${logTime}]</span>
          <span class="log-message">${message}</span>
        `;
        logEntries.appendChild(logEntry);
        
        // Scroll to the bottom of the log container
        const logContainer = document.querySelector('.log-container');
        logContainer.scrollTop = logContainer.scrollHeight;
      }
      
      // Clear logs
      document.getElementById('clear-logs').addEventListener('click', () => {
        logEntries.innerHTML = '';
        addLog('Logs cleared');
      });
      
      // Export logs
      document.getElementById('export-logs').addEventListener('click', () => {
        const logs = document.querySelectorAll('.log-entry');
        let logText = '';
        logs.forEach(log => {
          logText += log.textContent.trim() + '\n';
        });
        
        const blob = new Blob([logText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `linkedin-oauth-logs-${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        addLog('Logs exported successfully');
      });
      
      // Environment detection
      const baseUrl = window.location.origin;
      document.getElementById('base-url').textContent = baseUrl;
      
      // Get environment variables from the server
      try {
        const envResponse = await fetch('/api/linkedin/diagnostics');
        const envData = await envResponse.json();
        
        document.getElementById('repl-slug').textContent = envData.REPL_SLUG || 'Not available';
        document.getElementById('repl-owner').textContent = envData.REPL_OWNER || 'Not available';
        
        addLog(`Environment detected: REPL_SLUG=${envData.REPL_SLUG}, REPL_OWNER=${envData.REPL_OWNER}`);
      } catch (error) {
        document.getElementById('repl-slug').textContent = 'Error fetching';
        document.getElementById('repl-owner').textContent = 'Error fetching';
        addLog(`Error fetching environment: ${error.message}`, 'error');
      }
      
      // Generate redirect URIs
      const redirectUris = [
        `${baseUrl}/callback`,
        `${baseUrl}/api/callback`,
        `${baseUrl}/api/auth/callback`,
        `${baseUrl}/api/auth/linkedin/callback`
      ];
      
      const redirectUrisList = document.getElementById('redirect-uris-list');
      const redirectUriSelect = document.getElementById('redirect-uri-select');
      const redirectUriInput = document.getElementById('redirect-uri-input');
      
      redirectUris.forEach(uri => {
        // Add to the list
        const uriItem = document.createElement('div');
        uriItem.style.marginBottom = '10px';
        uriItem.innerHTML = `
          <code>${uri}</code>
          <button class="copy-button" data-uri="${uri}">Copy</button>
        `;
        redirectUrisList.appendChild(uriItem);
        
        // Add to the select dropdowns
        const selectOption = document.createElement('option');
        selectOption.value = uri;
        selectOption.textContent = uri;
        redirectUriSelect.appendChild(selectOption);
        
        const inputOption = document.createElement('option');
        inputOption.value = uri;
        inputOption.textContent = uri;
        redirectUriInput.appendChild(inputOption);
      });
      
      // Copy button functionality
      document.querySelectorAll('.copy-button').forEach(button => {
        button.addEventListener('click', () => {
          const uri = button.getAttribute('data-uri');
          navigator.clipboard.writeText(uri);
          button.textContent = 'Copied!';
          setTimeout(() => {
            button.textContent = 'Copy';
          }, 2000);
          
          addLog(`Copied to clipboard: ${uri}`);
        });
      });
      
      // Check credentials
      document.getElementById('check-credentials').addEventListener('click', async () => {
        try {
          addLog('Checking LinkedIn credentials...');
          document.getElementById('credentials-status').innerHTML = '<p>Checking credentials...</p>';
          
          const response = await fetch('/api/linkedin/check-credentials');
          const data = await response.json();
          
          if (data.clientIdExists && data.clientSecretExists) {
            document.getElementById('credentials-status').innerHTML = `
              <div class="status-box success">
                <h3>‚úì Credentials Found</h3>
                <p>Client ID: <code>${data.clientIdPrefix}...</code></p>
                <p>Client Secret: <code>${data.clientSecretPrefix}...</code></p>
                <p>Checked at: ${new Date(data.timestamp).toLocaleTimeString()}</p>
              </div>
            `;
            
            // Update status in the table
            if (data.clientIdPrefix === '86t5') {
              document.getElementById('client-id-status').innerHTML = '<span class="badge badge-success">Correct ‚úì</span>';
              document.getElementById('client-id-input').value = '86t5psw5yh4oj0';
              addLog('Client ID verified: Correct prefix (86t5)', 'info');
            } else {
              document.getElementById('client-id-status').innerHTML = `<span class="badge badge-danger">Incorrect ‚úó (${data.clientIdPrefix})</span>`;
              addLog(`Client ID verification failed: Found ${data.clientIdPrefix}, expected 86t5`, 'error');
            }
            
            if (data.clientSecretPrefix === 'WPL_') {
              document.getElementById('client-secret-status').innerHTML = '<span class="badge badge-success">Correct ‚úì</span>';
              addLog('Client Secret verified: Correct prefix (WPL_)', 'info');
            } else {
              document.getElementById('client-secret-status').innerHTML = `<span class="badge badge-danger">Incorrect ‚úó (${data.clientSecretPrefix})</span>`;
              addLog(`Client Secret verification failed: Found ${data.clientSecretPrefix}, expected WPL_`, 'error');
            }
          } else {
            document.getElementById('credentials-status').innerHTML = `
              <div class="status-box error">
                <h3>‚ö† Credential Issues</h3>
                <p>Client ID: ${data.clientIdExists ? `<span style="color:green">‚úì Found (${data.clientIdPrefix}...)</span>` : '<span style="color:red">‚úó Missing</span>'}</p>
                <p>Client Secret: ${data.clientSecretExists ? `<span style="color:green">‚úì Found (${data.clientSecretPrefix}...)</span>` : '<span style="color:red">‚úó Missing</span>'}</p>
              </div>
            `;
            
            if (!data.clientIdExists) {
              document.getElementById('client-id-status').innerHTML = '<span class="badge badge-danger">Missing ‚úó</span>';
              addLog('Client ID is missing', 'error');
            }
            
            if (!data.clientSecretExists) {
              document.getElementById('client-secret-status').innerHTML = '<span class="badge badge-danger">Missing ‚úó</span>';
              addLog('Client Secret is missing', 'error');
            }
          }
        } catch (error) {
          document.getElementById('credentials-status').innerHTML = `
            <div class="status-box error">
              <h3>Error Checking Credentials</h3>
              <p>${error.message}</p>
            </div>
          `;
          addLog(`Error checking credentials: ${error.message}`, 'error');
        }
      });
      
      // Test redirect URI
      document.getElementById('test-redirect-uri').addEventListener('click', () => {
        const selectedUri = document.getElementById('redirect-uri-select').value;
        
        if (!selectedUri) {
          alert('Please select a redirect URI to test');
          return;
        }
        
        addLog(`Testing redirect URI: ${selectedUri}`);
        
        // Add a test result to the redirect tab
        const redirectStatus = document.getElementById('redirect-uri-status');
        redirectStatus.className = 'status-box info';
        redirectStatus.innerHTML = `
          <h3>Testing Redirect URI</h3>
          <p>Testing accessibility of: <code>${selectedUri}</code></p>
          <p>This will open a new tab to test if the URI is accessible.</p>
        `;
        
        // Open the URI in a new tab
        window.open(selectedUri, '_blank');
      });
      
      // Test scopes
      document.getElementById('test-scopes').addEventListener('click', () => {
        const profileScope = document.getElementById('scope-profile').checked;
        const emailScope = document.getElementById('scope-email').checked;
        
        if (!profileScope && !emailScope) {
          alert('Please select at least one scope to test');
          return;
        }
        
        const scopes = [];
        if (profileScope) scopes.push('r_liteprofile');
        if (emailScope) scopes.push('r_emailaddress');
        
        const scopeString = scopes.join(' ');
        addLog(`Testing authentication with scopes: ${scopeString}`);
        
        // Update the full test form
        document.getElementById('scope-input').value = scopeString;
        
        // Switch to the test flow tab
        document.querySelector('.tab[data-tab="test-flow"]').click();
      });
      
      // Run full test
      document.getElementById('run-full-test').addEventListener('click', async () => {
        const clientId = document.getElementById('client-id-input').value.trim();
        const redirectUri = document.getElementById('redirect-uri-input').value;
        const scope = document.getElementById('scope-input').value.trim();
        
        if (!clientId) {
          alert('Please enter a Client ID');
          return;
        }
        
        if (!redirectUri) {
          alert('Please select a Redirect URI');
          return;
        }
        
        if (!scope) {
          alert('Please enter at least one scope');
          return;
        }
        
        addLog(`Running full authentication test with:
- Client ID: ${clientId}
- Redirect URI: ${redirectUri}
- Scopes: ${scope}`);
        
        // Generate a random state parameter
        const state = Math.random().toString(36).substring(2, 12);
        
        // Build the LinkedIn auth URL
        const params = new URLSearchParams({
          response_type: 'code',
          client_id: clientId,
          redirect_uri: redirectUri,
          state: state,
          scope: scope
        });
        
        const authUrl = `https://www.linkedin.com/oauth/v2/authorization?${params.toString()}`;
        
        // Display the test results
        document.getElementById('test-results').innerHTML = `
          <div class="status-box info">
            <h3>Authentication Request Prepared</h3>
            <p>An authentication request has been prepared with the following parameters:</p>
            <pre><code>Client ID: ${clientId}
Redirect URI: ${redirectUri}
State: ${state}
Scope: ${scope}</code></pre>
            <p>Click the button below to initiate the authentication flow:</p>
            <a href="${authUrl}" target="_blank" class="button">Start Authentication</a>
          </div>
        `;
        
        addLog(`Authentication URL generated: ${authUrl}`);
      });
      
      // Initialize - trigger credentials check on load
      document.getElementById('check-credentials').click();
      
      // Initial log
      addLog('LinkedIn OAuth Deep Diagnostics tool initialized', 'info');
    });
  </script>
</body>
</html>