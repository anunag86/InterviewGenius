<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LinkedIn Direct Connection Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      padding: 20px;
      line-height: 1.5;
      color: #333;
      max-width: 800px;
      margin: 0 auto;
    }
    h1, h2, h3 {
      color: #0077B5;
    }
    .container {
      margin-top: 30px;
    }
    .card {
      background: #f7f9fa;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .status-box {
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
    }
    .error {
      background-color: #fff0f0;
      border-left: 4px solid #d00;
    }
    .success {
      background-color: #f0fff0;
      border-left: 4px solid #0a0;
    }
    .info {
      background-color: #f0f7ff;
      border-left: 4px solid #0077B5;
    }
    .warning {
      background-color: #fffcf0;
      border-left: 4px solid #f0ad4e;
    }
    pre, code {
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      white-space: pre-wrap;
    }
    code {
      padding: 2px 5px;
      display: inline-block;
    }
    pre code {
      padding: 0;
    }
    button, .button {
      display: inline-block;
      background-color: #0077B5;
      color: white;
      text-decoration: none;
      padding: 10px 20px;
      border-radius: 4px;
      margin: 10px 0;
      font-weight: bold;
      border: none;
      cursor: pointer;
    }
    button:hover, .button:hover {
      background-color: #005e93;
    }
    .button.secondary {
      background-color: #6c757d;
    }
    .button.secondary:hover {
      background-color: #5a6268;
    }
    input[type="text"], select {
      width: 100%;
      padding: 10px;
      margin: 5px 0 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .copy-button {
      background-color: #eee;
      color: #333;
      border: 1px solid #ddd;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
      margin-left: 6px;
      cursor: pointer;
    }
    .copy-button:hover {
      background-color: #ddd;
    }
  </style>
</head>
<body>
  <h1>LinkedIn Direct Connection Test</h1>
  
  <div class="status-box info">
    <h3>âœ¨ Direct LinkedIn Connection</h3>
    <p>This tool bypasses our server authentication code and connects directly to LinkedIn with user-specified parameters.</p>
    <p><strong>Current Issue:</strong> LinkedIn refuses to connect</p>
  </div>
  
  <div class="card">
    <h2>Connection Parameters</h2>
    <p>Fill in these parameters to test a direct connection to LinkedIn's OAuth service:</p>
    
    <label for="client-id">Client ID:</label>
    <input type="text" id="client-id" value="86t5psw5yh4oj0" placeholder="e.g., 86t5psw5yh4oj0">
    
    <div>
      <h3>Redirect URI</h3>
      <select id="redirect-uri-select" style="margin-bottom: 20px;"></select>
      <div style="margin-top: 10px;">
        <label for="custom-redirect">Or enter custom redirect URI:</label>
        <input type="text" id="custom-redirect" placeholder="e.g., https://your-domain.com/callback">
      </div>
    </div>
    
    <h3>OAuth Scopes</h3>
    <div style="margin-bottom: 15px;">
      <input type="checkbox" id="scope-profile" checked>
      <label for="scope-profile">r_liteprofile (Basic profile)</label>
    </div>
    <div style="margin-bottom: 15px;">
      <input type="checkbox" id="scope-email" checked>
      <label for="scope-email">r_emailaddress (Email address)</label>
    </div>
    <div style="margin-bottom: 15px;">
      <input type="checkbox" id="scope-organization">
      <label for="scope-organization">r_organization_admin (Organization admin)</label>
    </div>
    <div style="margin-bottom: 15px;">
      <input type="checkbox" id="scope-share">
      <label for="scope-share">w_member_social (Ability to post content)</label>
    </div>
    
    <button id="connect-linkedin" class="button">Connect to LinkedIn</button>
  </div>
  
  <div id="result" class="card" style="display: none;">
    <h2>Connection Result</h2>
    <div id="result-content"></div>
  </div>
  
  <div class="card">
    <h2>Troubleshooting Tips</h2>
    <h3>If you see "Refused to connect" error:</h3>
    <ul>
      <li><strong>Client ID:</strong> Verify the Client ID matches what's in your LinkedIn Developer Console</li>
      <li><strong>Redirect URI:</strong> Make sure the exact redirect URI is allowed in your LinkedIn application settings</li>
      <li><strong>Application Permissions:</strong> Ensure your LinkedIn app has the right products enabled (Sign In with LinkedIn)</li>
      <li><strong>Application Status:</strong> Verify the application is active and not in development mode or restricted</li>
    </ul>
    
    <h3>If you see "Invalid Client" error:</h3>
    <ul>
      <li>Your application isn't configured correctly on LinkedIn or might be disabled</li>
      <li>The Client ID might be incorrect or belongs to a different organization</li>
      <li>Try using only the most basic scopes (r_liteprofile only)</li>
    </ul>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const baseUrl = window.location.origin;
      
      // Populate redirect URI options
      const redirectOptions = [
        `${baseUrl}/callback`,
        `${baseUrl}/api/callback`,
        `${baseUrl}/api/auth/callback`,
        `${baseUrl}/api/auth/linkedin/callback`
      ];
      
      const redirectSelect = document.getElementById('redirect-uri-select');
      redirectOptions.forEach(uri => {
        const option = document.createElement('option');
        option.value = uri;
        option.textContent = uri;
        redirectSelect.appendChild(option);
      });
      
      // Connect button handler
      document.getElementById('connect-linkedin').addEventListener('click', () => {
        // Get values
        const clientId = document.getElementById('client-id').value.trim();
        const customRedirect = document.getElementById('custom-redirect').value.trim();
        const redirectUri = customRedirect || redirectSelect.value;
        
        // Build scope string
        const scopes = [];
        if (document.getElementById('scope-profile').checked) scopes.push('r_liteprofile');
        if (document.getElementById('scope-email').checked) scopes.push('r_emailaddress');
        if (document.getElementById('scope-organization').checked) scopes.push('r_organization_admin');
        if (document.getElementById('scope-share').checked) scopes.push('w_member_social');
        
        if (scopes.length === 0) {
          alert('Please select at least one scope');
          return;
        }
        
        if (!clientId) {
          alert('Please enter a Client ID');
          return;
        }
        
        if (!redirectUri) {
          alert('Please select or enter a Redirect URI');
          return;
        }
        
        // Generate random state
        const state = Math.random().toString(36).substring(2, 15);
        
        // Build LinkedIn auth URL
        const params = new URLSearchParams({
          response_type: 'code',
          client_id: clientId,
          redirect_uri: redirectUri,
          state: state,
          scope: scopes.join(' ')
        });
        
        const authUrl = `https://www.linkedin.com/oauth/v2/authorization?${params.toString()}`;
        
        // Display URL before redirecting
        const resultDiv = document.getElementById('result');
        const resultContent = document.getElementById('result-content');
        resultDiv.style.display = 'block';
        resultContent.innerHTML = `
          <div class="status-box info">
            <h3>Connecting to LinkedIn...</h3>
            <p>Using the following URL:</p>
            <pre><code>${authUrl}</code></pre>
            <p>Redirecting in 3 seconds...</p>
          </div>
        `;
        
        // Store parameters in localStorage for return checking
        localStorage.setItem('linkedinTestState', state);
        localStorage.setItem('linkedinTestRedirectUri', redirectUri);
        localStorage.setItem('linkedinTestScopes', scopes.join(' '));
        localStorage.setItem('linkedinTestClientId', clientId);
        
        // Redirect after a short delay
        setTimeout(() => {
          window.location.href = authUrl;
        }, 3000);
      });
      
      // Check for a redirect back from LinkedIn
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      const state = urlParams.get('state');
      const error = urlParams.get('error');
      const errorDescription = urlParams.get('error_description');
      
      if (code || error) {
        const resultDiv = document.getElementById('result');
        const resultContent = document.getElementById('result-content');
        resultDiv.style.display = 'block';
        
        const savedState = localStorage.getItem('linkedinTestState');
        const savedRedirectUri = localStorage.getItem('linkedinTestRedirectUri');
        const savedScopes = localStorage.getItem('linkedinTestScopes');
        const savedClientId = localStorage.getItem('linkedinTestClientId');
        
        if (error) {
          // Error case
          resultContent.innerHTML = `
            <div class="status-box error">
              <h3>LinkedIn OAuth Error</h3>
              <p><strong>Error:</strong> ${error}</p>
              <p><strong>Description:</strong> ${errorDescription || 'No description provided'}</p>
              <h4>Troubleshooting:</h4>
              <ul>
                <li><strong>invalid_client</strong>: The client ID is invalid or the app doesn't have the right permissions</li>
                <li><strong>access_denied</strong>: The user denied access or the app doesn't have permission for the requested scopes</li>
                <li><strong>unauthorized_scope</strong>: The app doesn't have permission for one or more requested scopes</li>
                <li><strong>redirect_uri_mismatch</strong>: The redirect URI doesn't match what's configured in LinkedIn</li>
              </ul>
              <p><a href="#" id="retry-auth" class="button">Try Again</a></p>
            </div>
          `;
          
          document.getElementById('retry-auth').addEventListener('click', (e) => {
            e.preventDefault();
            window.location.href = window.location.pathname; // Reload without params
          });
        } else if (code) {
          // Success case
          resultContent.innerHTML = `
            <div class="status-box success">
              <h3>LinkedIn OAuth Success</h3>
              <p>Successfully received authorization code from LinkedIn.</p>
              <p><strong>Code:</strong> ${code.substring(0, 10)}...</p>
              <p><strong>State:</strong> ${state} ${savedState === state ? '(matches)' : '(doesn\'t match stored state)'}</p>
              <h4>Original Request Parameters:</h4>
              <pre><code>Client ID: ${savedClientId || 'Not available'}
Redirect URI: ${savedRedirectUri || 'Not available'}
Scopes: ${savedScopes || 'Not available'}</code></pre>
              <p>To complete the OAuth flow, this authorization code would need to be exchanged for an access token.</p>
              <p><a href="#" id="retry-auth" class="button">Start Over</a></p>
            </div>
          `;
          
          document.getElementById('retry-auth').addEventListener('click', (e) => {
            e.preventDefault();
            window.location.href = window.location.pathname; // Reload without params
          });
        }
      }
    });
  </script>
</body>
</html>